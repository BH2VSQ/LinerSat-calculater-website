<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>业余无线电卫星频率计算器</title>
    <!-- Local JS files -->
    <script src="./tailwindcss.js"></script>
    <script src="./satellite.min.js"></script>
    <style>
        /* Custom styles for a better look and feel */
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #111827; /* bg-gray-900 */
            color: #d1d5db; /* text-gray-300 */
        }
        .card {
            background-color: #1f2937; /* bg-gray-800 */
            border-radius: 0.75rem; /* rounded-xl */
            padding: 1.5rem; /* p-6 */
            border: 1px solid #374151; /* border-gray-700 */
        }
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem; /* rounded-lg */
            font-weight: 600;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            user-select: none;
        }
        .btn-primary {
            background-color: #4f46e5; /* bg-indigo-600 */
            color: white;
            border: 1px solid #4f46e5;
        }
        .btn-primary:hover {
            background-color: #4338ca; /* hover:bg-indigo-700 */
        }
        .btn-secondary {
            background-color: #374151; /* bg-gray-700 */
            color: #d1d5db; /* text-gray-300 */
            border: 1px solid #4b5563; /* border-gray-600 */
        }
        .btn-secondary:hover {
            background-color: #4b5563; /* hover:bg-gray-600 */
        }
        .input-field {
            background-color: #374151; /* bg-gray-700 */
            border: 1px solid #4b5563; /* border-gray-600 */
            color: #d1d5db; /* text-gray-300 */
            border-radius: 0.5rem; /* rounded-lg */
            padding: 0.5rem 0.75rem;
            width: 100%;
        }
        .input-field:focus {
            outline: none;
            border-color: #4f46e5; /* focus:border-indigo-600 */
            box-shadow: 0 0 0 2px #4f46e560;
        }
        .toast {
            position: fixed;
            top: 1rem;
            left: 50%;
            transform: translateX(-50%) translateY(-100%);
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            color: white;
            font-weight: 500;
            z-index: 50;
            opacity: 0;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        .toast.success { background-color: #16a34a; } /* bg-green-600 */
        .toast.error { background-color: #dc2626; } /* bg-red-600 */
        .toast.info { background-color: #2563eb; } /* bg-blue-600 */
    </style>
</head>
<body class="p-4 md:p-8">
    <div id="toast" class="toast"></div>

    <header class="text-center mb-6">
        <h1 class="text-3xl md:text-4xl font-bold text-white">业余无线电卫星频率计算器</h1>
        <p id="tle-status" class="text-sm text-gray-400 mt-1">正在初始化...</p>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Left Column: Settings -->
        <div class="lg:col-span-1 space-y-6">
            <div class="card">
                <h2 class="text-xl font-bold text-white mb-4">设置</h2>
                <div class="space-y-4">
                    <div>
                        <label for="satellite-select" class="block text-sm font-medium mb-1">选择卫星</label>
                        <select id="satellite-select" class="input-field"></select>
                    </div>
                    <div>
                        <button id="sync-tle-btn" class="btn btn-secondary w-full">手动同步星历</button>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2 class="text-xl font-bold text-white mb-4">观测点</h2>
                <div class="space-y-4">
                    <div class="flex items-end gap-2">
                        <div class="flex-grow">
                            <label for="maidenhead-input" class="block text-sm font-medium mb-1">梅登黑格网格</label>
                            <input type="text" id="maidenhead-input" class="input-field" placeholder="例如: PN11RT">
                        </div>
                        <button id="convert-grid-btn" class="btn btn-secondary">转换</button>
                    </div>
                    <p class="text-xs text-gray-400">当前位置: <span id="current-location">未设置</span></p>
                    <button id="sync-gps-btn" class="btn btn-primary w-full">同步GPS位置</button>
                </div>
            </div>

            <div id="satellite-info-card" class="card hidden">
                <h2 id="sat-info-name" class="text-xl font-bold text-white mb-3"></h2>
                <div id="sat-info-linear" class="hidden space-y-2 text-sm">
                    <p>上行范围: <span id="sat-info-uplink" class="font-mono"></span></p>
                    <p>下行范围: <span id="sat-info-downlink" class="font-mono"></span></p>
                    <p>信标频率: <span id="sat-info-beacon" class="font-mono"></span></p>
                    <p>模式: <span id="sat-info-mode" class="font-mono"></span></p>
                </div>
                 <div id="sat-info-fm" class="hidden space-y-2 text-sm">
                    <p>上行频率: <span id="sat-info-fm-uplink" class="font-mono"></span></p>
                    <p>下行频率: <span id="sat-info-fm-downlink" class="font-mono"></span></p>
                    <p>模式: <span class="font-mono">FM (语音/数字)</span></p>
                </div>
            </div>
        </div>

        <!-- Right Column: Data -->
        <div class="lg:col-span-2 space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="card">
                    <h2 class="text-xl font-bold text-white mb-4">实时跟踪</h2>
                    <div id="tracking-data-placeholder" class="flex items-center justify-center h-full text-gray-400">请先选择卫星并设置观测点。</div>
                    <div id="tracking-data-container" class="hidden grid grid-cols-2 gap-y-4 gap-x-4">
                        <div>
                            <p class="text-sm text-gray-400">方位角 (Az)</p>
                            <p id="azimuth" class="text-2xl font-bold text-white">-</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-400">仰角 (El)</p>
                            <p id="elevation" class="text-2xl font-bold text-white">-</p>
                        </div>
                        <div class="col-span-2">
                            <p class="text-sm text-gray-400">距离 (km)</p>
                            <p id="range" class="text-2xl font-bold text-white">-</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-400">多普勒 (Hz @145M)</p>
                            <p id="doppler-145" class="text-2xl font-bold text-white">-</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-400">多普勒 (Hz @435M)</p>
                            <p id="doppler-435" class="text-2xl font-bold text-white">-</p>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <h2 class="text-xl font-bold text-white mb-4">下次过境</h2>
                    <div id="pass-info-placeholder" class="flex items-center justify-center h-full text-gray-400">等待计算...</div>
                    <div id="pass-info-container" class="hidden space-y-2">
                         <div>
                            <p class="text-sm text-gray-400">状态</p>
                            <p id="pass-status" class="text-lg font-bold text-green-400">-</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-400">AOS / 倒计时 / LOS</p>
                            <p id="pass-aos" class="text-lg font-bold text-white">-</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-400">最大仰角 / 时长</p>
                            <p id="pass-details" class="text-lg font-bold text-white">-</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="linear-calculator-card" class="card">
                <h2 class="text-xl font-bold text-white mb-4">频率计算器</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4">
                    <!-- Uplink -->
                    <div>
                        <label for="uplink-freq" class="block text-center text-sm font-medium mb-2">上行频率 (MHz)</label>
                        <input type="number" id="uplink-freq" step="0.00001" class="input-field text-center font-mono text-lg mb-2">
                        <div class="flex justify-center items-center gap-1">
                            <button class="btn btn-secondary py-1 px-2 text-xs" onclick="adjustFreq('uplink', -10)">-10k</button>
                            <button class="btn btn-secondary py-1 px-2 text-xs" onclick="adjustFreq('uplink', -1)">-1k</button>
                            <button class="btn btn-secondary py-1 px-2 text-xs" onclick="adjustFreq('uplink', -0.1)">-100</button>
                            <button class="btn btn-secondary py-1 px-2 text-xs" onclick="adjustFreq('uplink', 0.1)">+100</button>
                            <button class="btn btn-secondary py-1 px-2 text-xs" onclick="adjustFreq('uplink', 1)">+1k</button>
                            <button class="btn btn-secondary py-1 px-2 text-xs" onclick="adjustFreq('uplink', 10)">+10k</button>
                        </div>
                        <p class="text-center text-xs text-gray-400 mt-2">计算出的下行频率</p>
                        <div id="calculated-downlink" class="mt-1 text-center font-mono text-xl h-8 p-1 bg-gray-900 rounded-md text-cyan-400">-</div>
                    </div>
                    <!-- Downlink -->
                    <div>
                        <label for="downlink-freq" class="block text-center text-sm font-medium mb-2">下行频率 (MHz)</label>
                         <input type="number" id="downlink-freq" step="0.00001" class="input-field text-center font-mono text-lg mb-2">
                         <div class="flex justify-center items-center gap-1">
                            <button class="btn btn-secondary py-1 px-2 text-xs" onclick="adjustFreq('downlink', -10)">-10k</button>
                            <button class="btn btn-secondary py-1 px-2 text-xs" onclick="adjustFreq('downlink', -1)">-1k</button>
                            <button class="btn btn-secondary py-1 px-2 text-xs" onclick="adjustFreq('downlink', -0.1)">-100</button>
                            <button class="btn btn-secondary py-1 px-2 text-xs" onclick="adjustFreq('downlink', 0.1)">+100</button>
                            <button class="btn btn-secondary py-1 px-2 text-xs" onclick="adjustFreq('downlink', 1)">+1k</button>
                            <button class="btn btn-secondary py-1 px-2 text-xs" onclick="adjustFreq('downlink', 10)">+10k</button>
                        </div>
                        <p class="text-center text-xs text-gray-400 mt-2">计算出的上行频率</p>
                        <div id="calculated-uplink" class="mt-1 text-center font-mono text-xl h-8 p-1 bg-gray-900 rounded-md text-yellow-400">-</div>
                    </div>
                </div>
            </div>
            
            <div id="fm-frequencies-card" class="card hidden">
                 <h2 class="text-xl font-bold text-white mb-4">FM 频率</h2>
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4">
                    <div>
                        <p class="text-center text-sm text-gray-400">上行频率 (MHz)</p>
                        <div id="fm-uplink-display" class="mt-1 text-center font-mono text-xl h-8 p-1 bg-gray-900 rounded-md text-yellow-400">-</div>
                    </div>
                     <div>
                        <p class="text-center text-sm text-gray-400">下行频率 (MHz)</p>
                        <div id="fm-downlink-display" class="mt-1 text-center font-mono text-xl h-8 p-1 bg-gray-900 rounded-md text-cyan-400">-</div>
                    </div>
                 </div>
            </div>

        </div>
    </div>
    
    <script>
        // --- Application Logic ---
        const SATELLITES = {
            // Linear Transponders
            'RS-44': { norad: 44909, type: 'linear', uplink_start: 145.935, uplink_end: 145.995, downlink_start: 435.670, downlink_end: 435.610, beacon: 435.605, inverting: true },
            'JO-97': { norad: 43803, type: 'linear', uplink_start: 435.100, uplink_end: 435.120, downlink_start: 145.875, downlink_end: 145.855, beacon: 145.840, inverting: true },
            'MO-122 / MESAT1': { norad: 60209, type: 'linear', uplink_start: 145.910, uplink_end: 145.940, downlink_start: 435.810, downlink_end: 435.840, beacon: 435.8, inverting: false },
            
            // FM Satellites
            'SO-50': { norad: 27607, type: 'fm', uplink: 145.8500, downlink: 436.7950 },
            'ISS FM': { norad: 25544, type: 'fm', uplink: 145.9900, downlink: 437.8000 },
            'ISS APRS(ARISS)': { norad: 25544, type: 'fm', uplink: 145.8250, downlink: 145.8250 },
            'ISS SSTV': { norad: 25544, type: 'fm', uplink: 145.8000, downlink: 145.8000 },
            'LAPAN-A2 (IO-86)': { norad: 40931, type: 'fm', uplink: 145.8800, downlink: 435.8800 },
            'FOX-1B (AO-91)': { norad: 43017, type: 'fm', uplink: 435.2500, downlink: 145.9600 },
            'DIWATA-2B (PO-101)': { norad: 43678, type: 'fm', uplink: 437.5000, downlink: 145.9000 },
            'ASRTU-1/RS64S (AO-123)': { norad: 61781, type: 'fm', uplink: 145.8500, downlink: 435.4000 },
            'HADES-R (SO-124)': { norad: 62690, type: 'fm', uplink: 145.9250, downlink: 436.8880 },
            'HADES-ICM (SO-125)': { norad: 63492, type: 'fm', uplink: 145.8750, downlink: 436.6660 },
            'SONATE-2 APRS(DP0SHX)': { norad: 59112, type: 'fm', uplink: 145.8250, downlink: 145.8250 },
            'SONATE-2 SSTV': { norad: 59112, type: 'fm', uplink: 145.8800, downlink: 145.8800 },
        };
        const DEFAULT_SATELLITE = 'RS-44';
        const TLE_SOURCE_URL = 'https://www.celestrak.com/NORAD/elements/amateur.txt';
        const FALLBACK_TLE = `
RS-44
1 44909U 19098A   24169.58584104  .00010042  00000+0  17889-3 0  9997
2 44909  87.8997 140.4045 0013002 108.3435 251.8124 15.19794024 45674
SO-50
1 27607U 02058C   24170.81438596  .00000455  00000+0  28375-3 0  9990
2 27607  64.5501 106.3392 0014316 288.7838  71.2185 14.77373351114562
`;

        let tleData = {};
        let observerLocation = null;
        let selectedSatelliteKey = null;
        let satrec = null;
        let trackingInterval = null;
        let passPredictionInterval = null;
        let passCountdownInterval = null;
        
        const satSelect = document.getElementById('satellite-select');
        const tleStatus = document.getElementById('tle-status');
        const currentLocationEl = document.getElementById('current-location');
        const maidenheadInput = document.getElementById('maidenhead-input');
        const trackingPlaceholder = document.getElementById('tracking-data-placeholder');
        const trackingContainer = document.getElementById('tracking-data-container');
        const passPlaceholder = document.getElementById('pass-info-placeholder');
        const passContainer = document.getElementById('pass-info-container');
        const azimuthEl = document.getElementById('azimuth');
        const elevationEl = document.getElementById('elevation');
        const rangeEl = document.getElementById('range');
        const doppler435El = document.getElementById('doppler-435');
        const doppler145El = document.getElementById('doppler-145');
        const uplinkFreqInput = document.getElementById('uplink-freq');
        const downlinkFreqInput = document.getElementById('downlink-freq');
        const calcDownlinkEl = document.getElementById('calculated-downlink');
        const calcUplinkEl = document.getElementById('calculated-uplink');
        const linearCalculatorCard = document.getElementById('linear-calculator-card');
        const fmFrequenciesCard = document.getElementById('fm-frequencies-card');
        const fmUplinkDisplay = document.getElementById('fm-uplink-display');
        const fmDownlinkDisplay = document.getElementById('fm-downlink-display');

        document.addEventListener('DOMContentLoaded', init);

        function init() {
            Object.keys(SATELLITES).forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                satSelect.appendChild(option);
            });
            satSelect.value = getCookie('selectedSatellite') || DEFAULT_SATELLITE;
            selectedSatelliteKey = satSelect.value;
            
            loadObserverLocation();
            setupEventListeners();
            loadTleData();

            updateSatelliteInfo();
            startStopTracking();
        }

        function setupEventListeners() {
            satSelect.addEventListener('change', onSatelliteChange);
            document.getElementById('sync-tle-btn').addEventListener('click', () => loadTleData(true));
            document.getElementById('sync-gps-btn').addEventListener('click', syncGpsLocation);
            document.getElementById('convert-grid-btn').addEventListener('click', convertMaidenhead);
            uplinkFreqInput.addEventListener('input', updateFrequencyCalculations);
            downlinkFreqInput.addEventListener('input', updateFrequencyCalculations);
        }

        async function loadTleData(forceOnline = false) {
            tleStatus.textContent = '正在获取星历...';
            let loadedFrom = null;

            if (!forceOnline) {
                const cachedTle = getCookie('tleData');
                if (cachedTle) {
                    try {
                        const parsedCache = JSON.parse(cachedTle);
                        if(parsedCache && parsedCache[SATELLITES[DEFAULT_SATELLITE].norad]) {
                            tleData = parsedCache;
                            loadedFrom = '缓存';
                        } else {
                           console.warn("Cached TLE data is invalid.");
                        }
                    } catch (e) { console.error("Error parsing cached TLE", e); }
                }
            }
            
            if (forceOnline || Object.keys(tleData).length === 0) {
                 try {
                    const response = await fetch(TLE_SOURCE_URL);
                    if (!response.ok) throw new Error(`Network response was not ok: ${response.statusText}`);
                    const tleText = await response.text();
                    const parsedOnlineTle = parseTle(tleText);
                    if (Object.keys(parsedOnlineTle).length > 0) {
                        tleData = parsedOnlineTle;
                        setCookie('tleData', JSON.stringify(tleData), 1);
                        loadedFrom = 'CelesTrak (在线)';
                        if (forceOnline) showToast('星历已从 CelesTrak 同步', 'success');
                    } else {
                        throw new Error("Parsed TLE from online source was empty.");
                    }
                } catch (error) {
                    console.error('Failed to fetch TLE online:', error);
                    if (Object.keys(tleData).length === 0) {
                        tleData = parseTle(FALLBACK_TLE);
                        loadedFrom = '内置备用数据';
                        showToast('在线同步失败，已使用内置备用数据', 'info');
                    } else {
                        loadedFrom = '缓存';
                        showToast('在线同步失败，正在使用缓存数据', 'info');
                    }
                }
            }
            
            tleStatus.textContent = `星历来源: ${loadedFrom}`;
            startStopTracking();
        }

        function parseTle(tleText) {
            const lines = tleText.trim().split('\n');
            const parsed = {};
            for (let i = 0; i < lines.length; i += 3) {
                 const name = lines[i].trim();
                 const line1 = lines[i + 1];
                 const line2 = lines[i + 2];
                if (name && line1 && line2 && line1.startsWith('1 ') && line2.startsWith('2 ')) {
                    const noradId = parseInt(line1.substring(2, 7), 10);
                    // Match by NORAD ID first
                    const satKey = Object.keys(SATELLITES).find(key => SATELLITES[key].norad === noradId);
                    if (satKey) {
                        parsed[noradId] = { tle1: line1, tle2: line2 };
                    }
                }
            }
            return parsed;
        }

        function loadObserverLocation() {
            const savedLocation = getCookie('observerLocation');
            if (savedLocation) {
                try {
                    observerLocation = JSON.parse(savedLocation);
                    updateLocationUI();
                } catch (e) {
                    console.error("Error parsing saved location", e);
                    observerLocation = null;
                }
            }
        }

        function saveObserverLocation() {
            if (observerLocation) {
                setCookie('observerLocation', JSON.stringify(observerLocation), 365);
            }
        }

        function updateLocationUI() {
            if (observerLocation) {
                currentLocationEl.textContent = `${observerLocation.lat.toFixed(4)}, ${observerLocation.lon.toFixed(4)} (${observerLocation.source})`;
                if (observerLocation.source === 'Grid' && observerLocation.grid) {
                    maidenheadInput.value = observerLocation.grid;
                } else {
                    maidenheadInput.value = latLonToGrid(observerLocation.lat, observerLocation.lon, 6);
                }
            } else {
                currentLocationEl.textContent = '未设置';
            }
        }

        function syncGpsLocation() {
            if (!navigator.geolocation) {
                showToast('浏览器不支持GPS定位', 'error');
                return;
            }
            showToast('正在请求GPS位置...', 'info');
            navigator.geolocation.getCurrentPosition(
                position => {
                    observerLocation = {
                        lat: position.coords.latitude,
                        lon: position.coords.longitude,
                        source: 'GPS'
                    };
                    updateLocationUI();
                    saveObserverLocation();
                    startStopTracking();
                    showToast('GPS位置同步成功', 'success');
                },
                error => {
                    console.error('GPS Error:', error);
                    showToast(`GPS定位失败: ${error.message}`, 'error');
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        }

        function convertMaidenhead() {
            const grid = maidenheadInput.value.trim().toUpperCase();
            try {
                const coords = gridToLatLon(grid);
                observerLocation = { lat: coords[0], lon: coords[1], source: 'Grid', grid: grid };
                updateLocationUI();
                saveObserverLocation();
                startStopTracking();
                showToast('网格转换成功', 'success');
            } catch (e) {
                showToast(e.message, 'error');
            }
        }

        function onSatelliteChange(event) {
            selectedSatelliteKey = event.target.value;
            setCookie('selectedSatellite', selectedSatelliteKey, 365);
            updateSatelliteInfo();
            startStopTracking();
        }

        function startStopTracking() {
            if (trackingInterval) clearInterval(trackingInterval);
            if (passPredictionInterval) clearInterval(passPredictionInterval);
            if(passCountdownInterval) clearInterval(passCountdownInterval);

            const satConfig = SATELLITES[selectedSatelliteKey];
            if (!satConfig) return;

            const tle = tleData[satConfig.norad];
            if (tle && observerLocation) {
                trackingPlaceholder.classList.add('hidden');
                trackingContainer.classList.remove('hidden');
                passPlaceholder.classList.add('hidden');
                passContainer.classList.remove('hidden');
                
                try {
                    satrec = satellite.twoline2satrec(tle.tle1, tle.tle2);
                } catch (e) {
                    console.error("Error initializing satrec:", e);
                    handlePropagationError();
                    return;
                }
                
                updateTrackingData(); 
                trackingInterval = setInterval(updateTrackingData, 1000);
                
                runPassPrediction();
                passPredictionInterval = setInterval(runPassPrediction, 5 * 60 * 1000);
            } else {
                trackingPlaceholder.classList.remove('hidden');
                trackingContainer.classList.add('hidden');
                passPlaceholder.classList.remove('hidden');
                passContainer.classList.add('hidden');
                if (!observerLocation) {
                    trackingPlaceholder.textContent = "请设置观测点以开始跟踪。";
                    passPlaceholder.textContent = "请设置观测点以预报过境。";
                } else if (!tle) {
                     trackingPlaceholder.textContent = `等待 ${selectedSatelliteKey} 的星历数据...`;
                     passPlaceholder.textContent = `等待 ${selectedSatelliteKey} 的星历数据...`;
                }
            }
        }

        function updateSatelliteInfo() {
            const satConfig = SATELLITES[selectedSatelliteKey];
            const infoCard = document.getElementById('satellite-info-card');
            if (satConfig) {
                document.getElementById('sat-info-name').textContent = selectedSatelliteKey;
                if (satConfig.type === 'linear') {
                    document.getElementById('sat-info-linear').classList.remove('hidden');
                    document.getElementById('sat-info-fm').classList.add('hidden');
                    linearCalculatorCard.classList.remove('hidden');
                    fmFrequenciesCard.classList.add('hidden');
                    
                    document.getElementById('sat-info-uplink').textContent = `${satConfig.uplink_start.toFixed(3)} - ${satConfig.uplink_end.toFixed(3)} MHz`;
                    const downlinkRange = satConfig.inverting 
                        ? `${Math.max(satConfig.downlink_start, satConfig.downlink_end).toFixed(3)} - ${Math.min(satConfig.downlink_start, satConfig.downlink_end).toFixed(3)} MHz`
                        : `${Math.min(satConfig.downlink_start, satConfig.downlink_end).toFixed(3)} - ${Math.max(satConfig.downlink_start, satConfig.downlink_end).toFixed(3)} MHz`;
                    document.getElementById('sat-info-downlink').textContent = downlinkRange;
                    document.getElementById('sat-info-beacon').textContent = satConfig.beacon ? `${satConfig.beacon.toFixed(3)} MHz` : '无';
                    document.getElementById('sat-info-mode').textContent = satConfig.inverting ? '倒置转发器 (Inverting)' : '非倒置转发器 (Non-inverting)';

                    const centerUplink = (satConfig.uplink_start + satConfig.uplink_end) / 2;
                    const centerDownlink = (satConfig.downlink_start + satConfig.downlink_end) / 2;
                    uplinkFreqInput.value = centerUplink.toFixed(5);
                    downlinkFreqInput.value = centerDownlink.toFixed(5);
                } else { // FM satellite
                    document.getElementById('sat-info-linear').classList.add('hidden');
                    document.getElementById('sat-info-fm').classList.remove('hidden');
                    linearCalculatorCard.classList.add('hidden');
                    fmFrequenciesCard.classList.remove('hidden');

                    document.getElementById('sat-info-fm-uplink').textContent = `${satConfig.uplink.toFixed(4)} MHz`;
                    document.getElementById('sat-info-fm-downlink').textContent = `${satConfig.downlink.toFixed(4)} MHz`;
                }
                infoCard.classList.remove('hidden');
                updateFrequencyCalculations();
            } else {
                infoCard.classList.add('hidden');
            }
        }
        
        function handlePropagationError() {
            if(trackingInterval) clearInterval(trackingInterval);
            if(passPredictionInterval) clearInterval(passPredictionInterval);
            if(passCountdownInterval) clearInterval(passCountdownInterval);
            
            azimuthEl.textContent = '计算失败';
            elevationEl.textContent = '计算失败';
            rangeEl.textContent = 'N/A';
            doppler435El.textContent = 'N/A';
            doppler145El.textContent = 'N/A';
            
            const passStatusEl = document.getElementById('pass-status');
            passStatusEl.textContent = '计算失败';
            passStatusEl.className = "text-lg font-bold text-red-400";
            document.getElementById('pass-aos').textContent = '请检查星历或系统时间';
            document.getElementById('pass-details').textContent = '-';
        }

        function updateTrackingData() {
            if (!satrec || !observerLocation) return;
            
            const now = new Date();
            const positionAndVelocity = satellite.propagate(satrec, now);
            
            if (!positionAndVelocity || !positionAndVelocity.position || !positionAndVelocity.velocity) {
                 console.error("Propagation failed at " + now);
                 handlePropagationError();
                 return;
            }

            const gmst = satellite.gstime(now);
            const observerGd = {
                longitude: satellite.degreesToRadians(observerLocation.lon),
                latitude: satellite.degreesToRadians(observerLocation.lat),
                height: 0.1 
            };
            
            const positionEcf = satellite.eciToEcf(positionAndVelocity.position, gmst);
            const lookAngles = satellite.ecfToLookAngles(observerGd, positionEcf);
            
            azimuthEl.textContent = satellite.radiansToDegrees(lookAngles.azimuth).toFixed(1) + '°';
            elevationEl.textContent = satellite.radiansToDegrees(lookAngles.elevation).toFixed(1) + '°';
            
            rangeEl.textContent = lookAngles.rangeSat ? lookAngles.rangeSat.toFixed(0) : '-';
            
            const observerEcf = satellite.geodeticToEcf(observerGd);
            const velocityEcf = satellite.eciToEcf(positionAndVelocity.velocity, gmst);
            const dopplerFactor = satellite.dopplerFactor(observerEcf, positionEcf, velocityEcf);
            
            const dopplerShift435 = (dopplerFactor - 1) * 435000000;
            doppler435El.textContent = !isNaN(dopplerShift435) ? dopplerShift435.toFixed(0) : '-';
            
            const dopplerShift145 = (dopplerFactor - 1) * 145000000;
            doppler145El.textContent = !isNaN(dopplerShift145) ? dopplerShift145.toFixed(0) : '-';
            
            updateFrequencyCalculations();
        }

        function updateFrequencyCalculations() {
            if (!satrec || !observerLocation) return;

            const satConfig = SATELLITES[selectedSatelliteKey];
            const now = new Date();
            const positionAndVelocity = satellite.propagate(satrec, now);
            
            if (!positionAndVelocity.position || !positionAndVelocity.velocity) return;

            const gmst = satellite.gstime(now);
            const observerGd = {
                longitude: satellite.degreesToRadians(observerLocation.lon),
                latitude: satellite.degreesToRadians(observerLocation.lat),
                height: 0.1
            };
            
            const observerEcf = satellite.geodeticToEcf(observerGd);
            const positionEcf = satellite.eciToEcf(positionAndVelocity.position, gmst);
            const velocityEcf = satellite.eciToEcf(positionAndVelocity.velocity, gmst);
            const dopplerFactor = satellite.dopplerFactor(observerEcf, positionEcf, velocityEcf);
            
            if (isNaN(dopplerFactor)) return;

            if (satConfig.type === 'linear') {
                const transponderCenterUp = (satConfig.uplink_start + satConfig.uplink_end) / 2 * 1e6;
                const transponderCenterDown = (satConfig.downlink_start + satConfig.downlink_end) / 2 * 1e6;

                const upFreqGround = parseFloat(uplinkFreqInput.value) * 1e6;
                if (!isNaN(upFreqGround)) {
                    const upFreqAtSat = upFreqGround * dopplerFactor;
                    const offset = upFreqAtSat - transponderCenterUp;
                    const downFreqAtSat = satConfig.inverting ? (transponderCenterDown - offset) : (transponderCenterDown + offset);
                    const downFreqAtGround = downFreqAtSat * dopplerFactor;
                    calcDownlinkEl.textContent = (downFreqAtGround / 1e6).toFixed(5);
                } else {
                     calcDownlinkEl.textContent = '-';
                }

                const downFreqGround = parseFloat(downlinkFreqInput.value) * 1e6;
                if (!isNaN(downFreqGround)) {
                    const downFreqAtSat = downFreqGround / dopplerFactor;
                    const offset = downFreqAtSat - transponderCenterDown;
                    const upFreqAtSat = satConfig.inverting ? (transponderCenterUp - offset) : (transponderCenterUp + offset);
                    const upFreqAtGround = upFreqAtSat / dopplerFactor;
                    calcUplinkEl.textContent = (upFreqAtGround / 1e6).toFixed(5);
                } else {
                    calcUplinkEl.textContent = '-';
                }
            } else { // FM satellite
                // **FIX**: Correct Doppler calculation for FM satellites.
                // Uplink: User must pre-correct, so divide by factor.
                const upDopplerCorrected = (satConfig.uplink * 1e6) / dopplerFactor; 
                // Downlink: User receives a shifted signal, so multiply by factor.
                const downDopplerCorrected = (satConfig.downlink * 1e6) * dopplerFactor; 
                fmUplinkDisplay.textContent = (upDopplerCorrected / 1e6).toFixed(5);
                fmDownlinkDisplay.textContent = (downDopplerCorrected / 1e6).toFixed(5);
            }
        }

        function adjustFreq(type, kHz) {
            const input = type === 'uplink' ? uplinkFreqInput : downlinkFreqInput;
            let currentValue = parseFloat(input.value);
            if (!isNaN(currentValue)) {
                currentValue += kHz * 0.001;
                input.value = currentValue.toFixed(5);
                updateFrequencyCalculations();
            }
        }

        function runPassPrediction() {
            if (passCountdownInterval) clearInterval(passCountdownInterval);
            if (!satrec || !observerLocation) return;
            
            const observerGd = {
                longitude: satellite.degreesToRadians(observerLocation.lon),
                latitude: satellite.degreesToRadians(observerLocation.lat),
                height: 0.1
            };
            
            const allPasses = [];
            let inPass = false;
            let currentPass = {};
            const now = new Date();
            const startTime = new Date(now.getTime() - 30 * 60 * 1000); 

            for (let i = 0; i < (48 * 60 * 2) + 60; i++) {
                const time = new Date(startTime.getTime() + i * 30 * 1000);
                const posVel = satellite.propagate(satrec, time);
                if (!posVel || !posVel.position) continue;
                
                const gmst = satellite.gstime(time);
                const lookAngles = satellite.ecfToLookAngles(observerGd, satellite.eciToEcf(posVel.position, gmst));
                const elevation = satellite.radiansToDegrees(lookAngles.elevation);

                if (elevation > 0 && !inPass) {
                    inPass = true;
                    currentPass = { aos: time, max_elevation: elevation, los: null };
                } else if (elevation <= 0 && inPass) {
                    inPass = false;
                    currentPass.los = time;
                    if (currentPass.los.getTime() > now.getTime()) {
                        allPasses.push(currentPass);
                    }
                    currentPass = {};
                    if (allPasses.length > 5) break;
                }

                if (inPass && elevation > currentPass.max_elevation) {
                    currentPass.max_elevation = elevation;
                }
            }
            
            const passToShow = allPasses.find(p => new Date(p.los).getTime() > now.getTime());
            
            if (passToShow) {
                updatePassCountdownUI(passToShow);
                passCountdownInterval = setInterval(() => updatePassCountdownUI(passToShow), 1000);
            } else {
                document.getElementById('pass-aos').textContent = "48小时内无过境";
                document.getElementById('pass-details').textContent = '-';
                document.getElementById('pass-status').textContent = '未过境';
                document.getElementById('pass-status').className = "text-lg font-bold text-gray-400";
            }
        }
        
        function updatePassCountdownUI(pass) {
            const nowMs = new Date().getTime();
            const aosTimeMs = new Date(pass.aos).getTime();
            const losTimeMs = new Date(pass.los).getTime();

            if (nowMs > losTimeMs) {
                if(passCountdownInterval) clearInterval(passCountdownInterval);
                setTimeout(runPassPrediction, 1000);
                return;
            }
            
            const durationMs = losTimeMs - aosTimeMs;
            const durationMinutes = Math.round(durationMs / 60000);
            const statusEl = document.getElementById('pass-status');
            const aosEl = document.getElementById('pass-aos');
            const detailsEl = document.getElementById('pass-details');
            
            if (nowMs < aosTimeMs) {
                const timeToAos = aosTimeMs - nowMs;
                statusEl.textContent = '即将过境';
                statusEl.className = "text-lg font-bold text-yellow-400";
                aosEl.innerHTML = `<span class="block text-sm font-normal">AOS at ${new Date(aosTimeMs).toLocaleTimeString()}</span>` + formatCountdown(timeToAos);

            } else {
                const timeToLos = losTimeMs - nowMs;
                statusEl.textContent = '正在过境';
                statusEl.className = "text-lg font-bold text-green-400";
                aosEl.innerHTML = `<span class="block text-sm font-normal">LOS at ${new Date(losTimeMs).toLocaleTimeString()}</span>` + formatCountdown(timeToLos);
            }
            
            detailsEl.textContent = `${pass.max_elevation.toFixed(1)}° / ${durationMinutes} 分钟`;
        }

        function setCookie(name, value, days) {
            let expires = "";
            if (days) {
                const date = new Date();
                date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                expires = "; expires=" + date.toUTCString();
            }
            document.cookie = name + "=" + (value || "") + expires + "; path=/; SameSite=Lax; secure";
        }

        function getCookie(name) {
            const nameEQ = name + "=";
            const ca = document.cookie.split(';');
            for (let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) == ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
        }

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast show ${type}`;
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function formatCountdown(ms) {
            if (ms < 0) ms = 0;
            const totalSeconds = Math.floor(ms / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }
        
        function gridToLatLon(grid) {
            grid = grid.toUpperCase();
            if (!/^[A-R]{2}[0-9]{2}([A-X]{2})?$/.test(grid)) {
                throw new Error("无效的梅登黑格网格");
            }

            let lon = (grid.charCodeAt(0) - 65) * 20 - 180;
            let lat = (grid.charCodeAt(1) - 65) * 10 - 90;
            
            lon += parseInt(grid.charAt(2), 10) * 2;
            lat += parseInt(grid.charAt(3), 10) * 1;
            
            if (grid.length === 6) {
                lon += (grid.charCodeAt(4) - 65) * (2 / 24);
                lat += (grid.charCodeAt(5) - 65) * (1 / 24);
                lon += 1 / 24;
                lat += 0.5 / 24;
            } else {
                lon += 1;
                lat += 0.5;
            }
            
            return [lat, lon];
        }
        
        function latLonToGrid(lat, lon, precision = 6) {
             const P = "ABCDEFGHIJKLMNOPQRSTUVWX";
             const lon_adj = lon + 180;
             const lat_adj = lat + 90;

             let grid = "";
             grid += P.charAt(Math.floor(lon_adj / 20));
             grid += P.charAt(Math.floor(lat_adj / 10));

             grid += String(Math.floor((lon_adj % 20) / 2));
             grid += String(Math.floor(lat_adj % 10));

             if (precision === 6) {
                 grid += P.charAt(Math.floor(((lon_adj % 20) % 2) / (2 / 24))).toLowerCase();
                 grid += P.charAt(Math.floor((lat_adj % 10) / (1 / 24))).toLowerCase();
             }
             return grid;
         }

    </script>
</body>
</html>
